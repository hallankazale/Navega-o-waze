<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Navega√ß√£o ‚Äî com busca vis√≠vel</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js" defer></script>

<style>
:root{--bg:#f6f7fb;--ink:#0b1020;--card:#fff;--blue:#198cff;--safeBot:env(safe-area-inset-bottom,12px)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);overflow:hidden}
.view{position:absolute;inset:0;display:none}.view.active{display:block}
#mapHome,#mapPreview,#mapNav{position:absolute;inset:0}
.leaflet-routing-container{display:none}
/* Sheet fixa */
.sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-radius:18px 18px 0 0;box-shadow:0 -10px 24px rgba(0,0,0,.15);padding:14px 14px calc(14px + var(--safeBot));z-index:9999}
.handle{width:46px;height:5px;border-radius:6px;background:#d7dcea;margin:6px auto 12px}
.search{display:flex;gap:8px;align-items:center;background:#f3f6ff;border:1px solid #e6e9f3;border-radius:14px;padding:10px 12px}
.search input{flex:1;border:none;outline:none;background:transparent;font-size:16px}
.btn{border:1px solid #e6e9f3;background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.12);font-weight:800;cursor:pointer}
.btn.primary{background:var(--blue);color:#fff;border-color:#0c6bd6}
.row{display:flex;gap:10px;margin-top:10px}
.sug{position:absolute;left:14px;right:14px;bottom:calc(210px + var(--safeBot));max-height:260px;overflow:auto;background:#fff;border:1px solid #e6e9f3;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.15);display:none;z-index:10000}
.sug .item{padding:12px;border-bottom:1px solid #eef1f7;cursor:pointer}.sug .item:last-child{border-bottom:none}
/* FAB para abrir a busca caso algo esconda a sheet */
#openSearch{position:fixed;right:16px;bottom:calc(90px + var(--safeBot));width:56px;height:56px;border-radius:28px;border:none;background:#198cff;color:#fff;box-shadow:0 10px 24px rgba(0,0,0,.2);z-index:10001;font-size:22px}
.toast{position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:10002;display:none}
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<section id="home" class="view active">
  <div id="mapHome"></div>
  <button id="openSearch">üîé</button>
  <div class="sheet" id="homeSheet">
    <div class="handle"></div>
    <div class="search">
      <svg viewBox="0 0 24 24" width="22" height="22"><path d="M15.5 15.5 20 20" stroke="#7987a3" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="6" stroke="#7987a3" stroke-width="2" fill="none"/></svg>
      <input id="homeInput" placeholder="Para onde?" autocomplete="off">
      <button class="btn" id="btnLoc">üìç Minha localiza√ß√£o</button>
    </div>
    <div class="row"><button class="btn primary" id="btnCalcHome" style="flex:1">Calcular rota</button></div>
    <div class="sug" id="homeSug"></div>
  </div>
</section>

<section id="preview" class="view">
  <div id="mapPreview"></div>
  <div class="sheet" style="padding-top:6px">
    <div style="font-weight:800" id="pvTitle">Seu local ‚Üí ‚Äî</div>
    <div style="margin-top:6px"><b id="pvTime">‚Äî</b> ‚Ä¢ <span id="pvMiniDist">‚Äî</span></div>
    <div style="color:#7a819a;margin-top:4px" id="pvVia">‚Äî</div>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnBack">Voltar</button>
      <button class="btn primary" id="btnGo">Ir agora</button>
    </div>
  </div>
</section>

<section id="nav" class="view">
  <div id="mapNav"></div>
</section>

<script>
const $=s=>document.querySelector(s);
function show(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));$(id).classList.add('active'); setTimeout(()=>{if(id==='#home')mapHome.invalidateSize(); if(id==='#preview')mapPreview.invalidateSize(); if(id==='#nav')mapNav.invalidateSize();},100);}

let mapHome,mapPreview,mapNav;
function buildMaps(){
  mapHome=L.map('mapHome',{zoomControl:false}).setView([-15.78,-47.93],5);
  mapPreview=L.map('mapPreview',{zoomControl:false}).setView([-15.78,-47.93],13);
  mapNav=L.map('mapNav',{zoomControl:false}).setView([-15.78,-47.93],15);
  const tiles='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  [mapHome,mapPreview,mapNav].forEach(m=>L.tileLayer(tiles,{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(m));
}

window.addEventListener('load',()=>{
  if(!window.L){ return; }
  buildMaps();
  $('#openSearch').addEventListener('click',()=>{ const sh=$('#homeSheet'); sh.style.display='block'; sh.style.opacity='1'; sh.style.transform='none'; });

  const NOMI_S=q=>`https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=7&q=${encodeURIComponent(q)}`;
  const NOMI_R=(la,lo)=>`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${la}&lon=${lo}`;
  const kmfmt=m=>m>=1000?(m/1000).toFixed(1).replace('.',',')+' km':Math.max(1,Math.round(m))+' m';
  const durfmt=s=>{const h=Math.floor(s/3600),m=Math.round((s%3600)/60);return h?`${h} h ${m} min`:`${m} min`;};

  const routing=L.Routing.control({ router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}), waypoints:[], show:false, lineOptions:{styles:[{color:'#6c3cff',weight:7,opacity:.95}]} }).addTo(mapPreview);
  const routingNav=L.Routing.control({ router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}), waypoints:[], show:false, lineOptions:{styles:[{color:'#6c3cff',weight:7,opacity:.95}]} }).addTo(mapNav);

  let originLL=null, originLabel='Seu local', destLL=null, destLabel='‚Äî';

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async p=>{
      originLL=L.latLng(p.coords.latitude,p.coords.longitude);
      mapHome.setView(originLL,15);
      try{const j=await fetch(NOMI_R(originLL.lat,originLL.lng)).then(r=>r.json()); originLabel=j.display_name?.split(',')[0]||'Seu local';}catch{}
    },()=>{}, {enableHighAccuracy:true,timeout:8000,maximumAge:1000});
  }

  const homeInput=$('#homeInput'),homeSug=$('#homeSug'); let lastRes=[], tt=null;
  homeInput.addEventListener('input', ()=>{
    const q=homeInput.value.trim(); if(tt) clearTimeout(tt);
    if(!q){ homeSug.style.display='none'; return; }
    tt=setTimeout(async ()=>{
      try{
        const arr=await fetch(NOMI_S(q),{headers:{'Accept-Language':'pt-BR'}}).then(r=>r.json());
        lastRes=arr.map(o=>({label:o.display_name,lat:+o.lat,lon:+o.lon}));
        homeSug.innerHTML=lastRes.map((o,i)=>`<div class="item" data-i="${i}"><b>${o.label.split(',')[0]}</b><div style="color:#7b86a6;font-size:12px">${o.label.split(',').slice(1).join(', ')}</div></div>`).join('');
        homeSug.style.display=lastRes.length?'block':'none';
      }catch{ homeSug.style.display='none'; }
    },280);
  });
  homeSug.addEventListener('click', e=>{
    const n=e.target.closest('.item'); if(!n) return;
    const i=+n.dataset.i, pick=lastRes[i];
    homeInput.value=pick.label; homeSug.style.display='none';
    destLL=L.latLng(pick.lat,pick.lon); destLabel=pick.label; goPreview();
  });
  homeInput.addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnCalcHome').click(); });
  $('#btnCalcHome').addEventListener('click', async ()=>{
    const q=homeInput.value.trim(); if(!q) return alert('Digite um destino.');
    if(!destLL){
      const arr=await fetch(NOMI_S(q)).then(r=>r.json()).catch(()=>[]);
      if(!arr[0]) return alert('Endere√ßo n√£o encontrado.');
      destLL=L.latLng(+arr[0].lat,+arr[0].lon); destLabel=arr[0].display_name;
    }
    goPreview();
  });
  $('#btnLoc').addEventListener('click', ()=>{
    if(!navigator.geolocation) return alert('Ative/permita a Localiza√ß√£o.');
    navigator.geolocation.getCurrentPosition(async p=>{
      originLL=L.latLng(p.coords.latitude,p.coords.longitude);
      mapHome.setView(originLL,16);
      try{const j=await fetch(NOMI_R(originLL.lat,originLL.lng)).then(r=>r.json()); originLabel=j.display_name?.split(',')[0]||'Seu local'; }catch{}
    },()=>alert('Permita acesso ao GPS.'),{enableHighAccuracy:true,timeout:10000,maximumAge:1000});
  });

  function goPreview(){
    if(!originLL) originLL=mapHome.getCenter();
    show('#preview'); $('#pvTitle').textContent=`${originLabel} ‚Üí ${destLabel.split(',')[0]}`;
    routing.setWaypoints([originLL,destLL]);
  }
  routing.on('routesfound', e=>{
    const r=e.routes[0];
    $('#pvTime').textContent=durfmt(r.summary.totalTime||0);
    $('#pvMiniDist').textContent=kmfmt(r.summary.totalDistance||0);
    $('#pvVia').textContent=r.instructions?.[0]?.road || r.instructions?.[0]?.text?.split(',')[0] || 'Melhor rota';
    mapPreview.fitBounds(L.latLngBounds(r.coordinates),{padding:[40,40]});
  });
  $('#btnBack').addEventListener('click', ()=>show('#home'));
  $('#btnGo').addEventListener('click', ()=>{ show('#nav'); routingNav.setWaypoints([originLL,destLL]); setTimeout(()=>mapNav.invalidateSize(),100); });
});
</script>
</body>
</html>
